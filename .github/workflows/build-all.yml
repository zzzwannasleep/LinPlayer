# Build all platform packages and publish a nightly release in one workflow run.

name: Build Nightly (All Packages)
run-name: Nightly (${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: Version name (e.g. 1.2.3)
        required: true
      build_number:
        description: Build number (integer)
        required: true
      build_appletv:
        description: Build Apple TV (tvOS) package (experimental; requires custom tvOS host app/engine)
        type: boolean
        required: false
        default: false
      allow_debug_signing:
        description: Allow Android debug signing in CI (NOT OTA-safe). Only use if ANDROID_KEYSTORE_* secrets are not configured yet.
        type: boolean
        required: false
        default: false
      dandanplay_proxy_url:
        description: Optional Cloudflare Worker base URL for built-in DandanPlay proxy routing (e.g. https://danmuverify.902541.xyz)
        required: false
        default: ""

concurrency:
  group: nightly-release
  cancel-in-progress: true

jobs:
  build-android:
    name: Build Android APK (v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ubuntu-latest
    env:
      PUB_CACHE: /home/runner/.pub-cache
      LINPLAYER_ALLOW_CI_DEBUG_SIGNING: ${{ github.event.inputs.allow_debug_signing }}
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Flutter analyze
        run: flutter analyze

      - name: Flutter tests
        run: flutter test

      - name: Fetch TV proxy assets (mihomo + metacubexd)
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: ./tool/fetch_tv_proxy_assets.ps1

      - name: Configure Android release signing (OTA-safe)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -n "${ANDROID_KEYSTORE_BASE64:-}" ]]; then
            python3 .github/scripts/decode_android_keystore.py android/release.keystore

            # key.properties is read from android/app via rootProject.file("key.properties"),
            # and storeFile is resolved relative to android/app (Gradle ':app' module).
            printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=../release.keystore\n" \
              "$ANDROID_KEYSTORE_PASSWORD" \
              "$ANDROID_KEY_PASSWORD" \
              "$ANDROID_KEY_ALIAS" \
              > android/key.properties

            # Fail fast with a clear error if the keystore/password/alias don't actually work,
            # instead of spending minutes on a build just to fail at :app:packageRelease.
            bash .github/scripts/verify_android_signing.sh \
              android/release.keystore \
              "$ANDROID_KEYSTORE_PASSWORD" \
              "$ANDROID_KEY_PASSWORD" \
              "$ANDROID_KEY_ALIAS"
          else
            if [[ "${LINPLAYER_ALLOW_CI_DEBUG_SIGNING:-}" =~ ^(1|true|yes)$ ]]; then
              echo "No ANDROID_KEYSTORE_BASE64 secret set; proceeding with debug signing (NOT OTA-safe)."
            else
              echo "No ANDROID_KEYSTORE_BASE64 secret set; refusing to build release APKs in CI." >&2
              echo "OTA upgrades require a stable signing key. Configure ANDROID_KEYSTORE_* secrets/env vars," >&2
              echo "or re-run this workflow with allow_debug_signing=true to force debug signing (not OTA-safe)." >&2
              exit 1
            fi
          fi

      - name: Build APKs (split + universal)
        shell: bash
        run: |
          set -euo pipefail
          OUT_DIR="build/ci-android-apks"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          DART_DEFINE_ARGS=()
          if [[ -n "${DANDANPLAY_PROXY_URL:-}" ]]; then
            DART_DEFINE_ARGS+=(--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL="${DANDANPLAY_PROXY_URL}")
          fi

          flutter build apk --release --split-per-abi --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"
          cp -v build/app/outputs/flutter-apk/app-arm64-v8a-release.apk "$OUT_DIR/LinPlayer-Android-arm64-v8a.apk"
          cp -v build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk "$OUT_DIR/LinPlayer-Android-TV.apk"

          flutter build apk --release --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"
          cp -v build/app/outputs/flutter-apk/app-release.apk "$OUT_DIR/LinPlayer-Android.apk"

          echo "--- Staged APKs ---"
          ls -la "$OUT_DIR"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Android-APKs-${{ env.VERSION_FULL }}
          path: build/ci-android-apks/*.apk

  build-windows:
    name: Build Windows Setup (x64, v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: windows-latest
    env:
      PUB_CACHE: C:\Users\runneradmin\AppData\Local\Pub\Cache
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        shell: pwsh
        run: dart run flutter_launcher_icons

      - name: Compute build version
        shell: pwsh
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: .github/scripts/compute_version.ps1

      - name: Enable Windows desktop support
        run: flutter config --enable-windows-desktop

      - name: Verify Windows platform scaffolding
        shell: pwsh
        run: |
          if (-not (Test-Path "windows/flutter")) {
            throw "windows/flutter is missing. Commit the Windows platform files; do not run flutter create in CI."
          }

      - name: Build Windows executable
        shell: pwsh
        run: |
          $dartDefineArgs = @()
          if (-not [string]::IsNullOrWhiteSpace($env:DANDANPLAY_PROXY_URL)) {
            $dartDefineArgs += "--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL=$env:DANDANPLAY_PROXY_URL"
          }
          flutter build windows --release --build-name $env:BUILD_NAME --build-number $env:BUILD_NUMBER @dartDefineArgs

      - name: Copy MSVC runtime DLLs
        shell: pwsh
        run: |
          $release64 = "build/windows/x64/runner/Release"
          $releaseLegacy = "build/windows/runner/Release"
          if (Test-Path $release64) {
            $release = $release64
          } elseif (Test-Path $releaseLegacy) {
            $release = $releaseLegacy
          } else {
            Write-Error "Release folder not found after build."
            exit 1
          }

          $roots = @(
            "C:\Program Files\Microsoft Visual Studio\2022",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022"
          )
          $crtDir = $null
          foreach ($root in $roots) {
            foreach ($edition in @("Enterprise","Professional","Community","BuildTools")) {
              $search = Join-Path $root "$edition\VC\Redist\MSVC"
              if (-not (Test-Path $search)) { continue }
              $found = Get-ChildItem -Directory -Recurse -Filter "Microsoft.VC143.CRT" $search | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              if (-not $found) {
                $found = Get-ChildItem -Directory -Recurse -Filter "Microsoft.VC142.CRT" $search | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              }
              if ($found) { $crtDir = $found.FullName; break }
            }
            if ($crtDir) { break }
          }
          if (-not $crtDir) { Write-Error "MSVC CRT path not found."; exit 1 }
          Copy-Item -Path (Join-Path $crtDir "*") -Destination $release -Recurse -Force

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: pwsh
        run: |
          $release64 = "build/windows/x64/runner/Release"
          $releaseLegacy = "build/windows/runner/Release"
          if (Test-Path $release64) {
            $release = $release64
          } elseif (Test-Path $releaseLegacy) {
            $release = $releaseLegacy
          } else {
            throw "Release folder not found after build."
          }

          if ([string]::IsNullOrWhiteSpace($env:APP_VERSION) -or [string]::IsNullOrWhiteSpace($env:APP_VERSION_FULL)) {
            throw "Missing APP_VERSION/APP_VERSION_FULL env vars. Did 'Compute build version' run?"
          }

          $env:SOURCE_DIR = (Resolve-Path $release).Path
          $env:OUTPUT_DIR = (Resolve-Path ".").Path
          $env:APP_ARCH = "x64"
          # APP_VERSION / APP_VERSION_FULL already set by compute_version.ps1

          $iscc = Join-Path ${env:ProgramFiles(x86)} "Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) { $iscc = Join-Path $env:ProgramFiles "Inno Setup 6\\ISCC.exe" }
          if (-not (Test-Path $iscc)) {
            $cmd = Get-Command ISCC.exe -ErrorAction SilentlyContinue
            if ($cmd) { $iscc = $cmd.Source }
          }
          if (-not (Test-Path $iscc)) { throw "ISCC.exe not found." }

          & $iscc ".github/installer/windows/linplayer.iss"
      
      - name: Rename installer for distribution
        shell: pwsh
        run: |
          if (Test-Path "LinPlayer-Setup-x64.exe") {
            Rename-Item -Path "LinPlayer-Setup-x64.exe" -NewName "LinPlayer-Windows-Setup-x64.exe" -Force
          } elseif (-not (Test-Path "LinPlayer-Windows-Setup-x64.exe")) {
            throw "Installer output not found."
          }

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Windows-Setup-${{ env.VERSION_FULL }}
          path: LinPlayer-Windows-Setup-x64.exe

  build-linux:
    name: Build Linux Tarball (x86_64, v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ubuntu-latest
    env:
      PUB_CACHE: /home/runner/.pub-cache
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install Linux build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libasound2-dev libmpv-dev

      - name: Enable Linux desktop support
        run: flutter config --enable-linux-desktop

      - name: Verify Linux platform scaffolding
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "linux/flutter" ]]; then
            echo "linux/flutter is missing. Commit the Linux platform files; do not run flutter create in CI." >&2
            exit 1
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Build Linux app
        shell: bash
        run: |
          set -euo pipefail
          DART_DEFINE_ARGS=()
          if [[ -n "${DANDANPLAY_PROXY_URL:-}" ]]; then
            DART_DEFINE_ARGS+=(--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL="${DANDANPLAY_PROXY_URL}")
          fi
          flutter build linux --release --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"

      - name: Create Linux tarball
        shell: bash
        run: |
          set -euo pipefail

          BUNDLE_DIR="build/linux/x64/release/bundle"
          if [[ ! -d "$BUNDLE_DIR" ]]; then
            BUNDLE_DIR="$(find build/linux -maxdepth 6 -type d -name bundle 2>/dev/null | grep '/release/' | head -n 1 || true)"
          fi
          if [[ -z "${BUNDLE_DIR:-}" || ! -d "$BUNDLE_DIR" ]]; then
            echo "Could not find Linux build bundle under build/linux." >&2
            find build/linux -maxdepth 6 -print || true
            exit 1
          fi

          STAGING="$RUNNER_TEMP/linplayer-linux"
          rm -rf "$STAGING"
          mkdir -p "$STAGING/LinPlayer"
          cp -a "$BUNDLE_DIR/." "$STAGING/LinPlayer/"

          tar -C "$STAGING" -czf LinPlayer-Linux-x86_64.tar.gz LinPlayer
          ls -la LinPlayer-Linux-x86_64.tar.gz

      - name: Upload Linux tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Linux-Tarball-x86_64-${{ env.VERSION_FULL }}
          path: LinPlayer-Linux-x86_64.tar.gz

  build-ios:
    name: Build iOS Unsigned IPA (v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: macos-latest
    env:
      PUB_CACHE: /Users/runner/.pub-cache
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Harden curl downloads (macOS)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/ci-bin"
          cat > "$RUNNER_TEMP/ci-bin/curl" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          exec /usr/bin/curl --retry-all-errors --http1.1 "$@"
          EOF
          chmod +x "$RUNNER_TEMP/ci-bin/curl"
          echo "PATH=$RUNNER_TEMP/ci-bin:$PATH" >> "$GITHUB_ENV"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Build iOS app (no codesign)
        shell: bash
        run: |
          set -euo pipefail
          DART_DEFINE_ARGS=()
          if [[ -n "${DANDANPLAY_PROXY_URL:-}" ]]; then
            DART_DEFINE_ARGS+=(--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL="${DANDANPLAY_PROXY_URL}")
          fi

          # flutter build ios --no-codesign can return a non-zero exit code on CI
          # with the generic "select a Development Team" message, even though the
          # Xcode build already produced a usable .app. Treat it as a soft-fail
          # when build output exists, so we can still package an unsigned IPA.
          set +e
          flutter build ios --release --no-codesign --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"
          status=$?
          set -e

          if [[ "$status" -ne 0 ]]; then
            echo "flutter build ios exited with $status; checking for built app output..."

            APP_PATH="$(find build/ios -maxdepth 6 -type d -name '*.app' 2>/dev/null | grep -v RunnerTests | head -n 1 || true)"
            if [[ -z "${APP_PATH:-}" ]]; then
              ARCHIVE_PATH="$(find build/ios -maxdepth 6 -type d -name '*.xcarchive' 2>/dev/null | head -n 1 || true)"
              if [[ -n "${ARCHIVE_PATH:-}" ]]; then
                APP_PATH="$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name '*.app' 2>/dev/null | head -n 1 || true)"
              fi
            fi

            if [[ -z "${APP_PATH:-}" || ! -d "$APP_PATH" ]]; then
              echo "No built .app found under build/ios; failing."
              exit "$status"
            fi

            echo "Found built app despite non-zero exit: $APP_PATH"
          fi

      - name: Package unsigned IPA
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$(find build/ios -maxdepth 6 -type d -name '*.app' 2>/dev/null | grep -v RunnerTests | head -n 1 || true)"
          if [[ -z "${APP_PATH:-}" ]]; then
            ARCHIVE_PATH="$(find build/ios -maxdepth 6 -type d -name '*.xcarchive' 2>/dev/null | head -n 1 || true)"
            if [[ -n "${ARCHIVE_PATH:-}" ]]; then
              APP_PATH="$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name '*.app' 2>/dev/null | head -n 1 || true)"
            fi
          fi
          if [[ -z "${APP_PATH:-}" || ! -d "$APP_PATH" ]]; then
            echo "Could not find built .app under build/ios."
            echo "--- Debug: build/ios (maxdepth 4) ---"
            find build/ios -maxdepth 4 -print || true
            echo "--- Debug: build/ios/iphoneos ---"
            ls -la build/ios/iphoneos || true
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          /usr/bin/zip -qry LinPlayer-iOS-unsigned.ipa Payload

      - name: Upload unsigned IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-iOS-Unsigned-IPA-${{ env.VERSION_FULL }}
          path: LinPlayer-iOS-unsigned.ipa

  build-macos:
    name: Build macOS DMG (${{ matrix.arch }}, v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-15
          - arch: x86_64
            runner: macos-15-intel
    env:
      PUB_CACHE: /Users/runner/.pub-cache
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Harden curl downloads (macOS)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/ci-bin"
          cat > "$RUNNER_TEMP/ci-bin/curl" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          exec /usr/bin/curl --retry-all-errors --http1.1 "$@"
          EOF
          chmod +x "$RUNNER_TEMP/ci-bin/curl"
          echo "PATH=$RUNNER_TEMP/ci-bin:$PATH" >> "$GITHUB_ENV"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Enable macOS desktop support
        run: flutter config --enable-macos-desktop

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Build macOS app
        shell: bash
        run: |
          set -euo pipefail
          DART_DEFINE_ARGS=()
          if [[ -n "${DANDANPLAY_PROXY_URL:-}" ]]; then
            DART_DEFINE_ARGS+=(--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL="${DANDANPLAY_PROXY_URL}")
          fi
          flutter build macos --release --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"

      - name: Create DMG installer
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$(find build/macos -maxdepth 7 -type d -name '*.app' 2>/dev/null | grep -v 'RunnerTests' | head -n 1 || true)"
          if [[ -z "${APP_PATH:-}" || ! -d "$APP_PATH" ]]; then
            echo "Could not find built .app under build/macos."
            find build/macos -maxdepth 5 -print || true
            exit 1
          fi

          STAGING="$RUNNER_TEMP/dmg-staging"
          rm -rf "$STAGING"
          mkdir -p "$STAGING"
          ditto "$APP_PATH" "$STAGING/$(basename "$APP_PATH")"
          ln -s /Applications "$STAGING/Applications"
          hdiutil create -volname "LinPlayer" -srcfolder "$STAGING" -ov -format UDZO "LinPlayer-macOS-${{ matrix.arch }}.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-macOS-DMG-${{ matrix.arch }}-${{ env.VERSION_FULL }}
          path: LinPlayer-macOS-${{ matrix.arch }}.dmg
  
  build-appletv:
    name: Build Apple TV (tvOS) (v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(github.event.inputs.build_appletv == 'true' && '[{"runner":"macos-latest","enabled":true}]' || '[{"runner":"ubuntu-latest","enabled":false}]') }}
    env:
      DANDANPLAY_PROXY_URL: ${{ github.event.inputs.dandanplay_proxy_url }}
    steps:
      - name: Apple TV build disabled
        if: ${{ !matrix.enabled }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Apple TV (tvOS) build disabled (build_appletv=false)."

      - name: Check out code
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4

      - name: Harden curl downloads (macOS)
        if: ${{ matrix.enabled }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/ci-bin"
          cat > "$RUNNER_TEMP/ci-bin/curl" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          exec /usr/bin/curl --retry-all-errors --http1.1 "$@"
          EOF
          chmod +x "$RUNNER_TEMP/ci-bin/curl"
          echo "PATH=$RUNNER_TEMP/ci-bin:$PATH" >> "$GITHUB_ENV"

      - name: Set up Flutter
        if: ${{ matrix.enabled }}
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Compute build version
        if: ${{ matrix.enabled }}
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Verify tvOS scaffold exists
        if: ${{ matrix.enabled }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -d "tvos" ]]; then
            echo "Missing tvOS scaffold: expected a top-level tvos/ directory." >&2
            echo "Flutter stable does not ship tvOS support; you must provide a custom tvOS host app/engine to build Apple TV." >&2
            exit 1
          fi

      - name: Build Apple TV app (no codesign)
        if: ${{ matrix.enabled }}
        shell: bash
        run: |
          set -euo pipefail
          DART_DEFINE_ARGS=()
          if [[ -n "${DANDANPLAY_PROXY_URL:-}" ]]; then
            DART_DEFINE_ARGS+=(--dart-define=LINPLAYER_DANDANPLAY_PROXY_URL="${DANDANPLAY_PROXY_URL}")
          fi

          if [[ -d "ios" ]]; then
            mv ios ios-iphone
          fi
          mv tvos ios
          restore() {
            if [[ -d "ios" ]]; then
              mv ios tvos
            fi
            if [[ -d "ios-iphone" ]]; then
              mv ios-iphone ios
            fi
          }
          trap restore EXIT

          flutter pub get
          dart run flutter_launcher_icons

          # Note: Flutter stable does not officially support tvOS. This build requires a custom
          # tvOS host app + engine setup under tvos/ that can be built via flutter build ios.
          flutter build ios --release --no-codesign --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER" "${DART_DEFINE_ARGS[@]}"

      - name: Package unsigned IPA
        if: ${{ matrix.enabled }}
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$(find build/ios -maxdepth 6 -type d -name '*.app' 2>/dev/null | grep -v RunnerTests | head -n 1 || true)"
          if [[ -z "${APP_PATH:-}" ]]; then
            ARCHIVE_PATH="$(find build/ios -maxdepth 6 -type d -name '*.xcarchive' 2>/dev/null | head -n 1 || true)"
            if [[ -n "${ARCHIVE_PATH:-}" ]]; then
              APP_PATH="$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name '*.app' 2>/dev/null | head -n 1 || true)"
            fi
          fi

          if [[ -z "${APP_PATH:-}" || ! -d "$APP_PATH" ]]; then
            echo "Could not find built .app under build/ios." >&2
            find build/ios -maxdepth 4 -print || true
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          /usr/bin/zip -qry LinPlayer-AppleTV-unsigned.ipa Payload

      - name: Upload unsigned IPA artifact
        if: ${{ matrix.enabled }}
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-AppleTV-Unsigned-IPA-${{ env.VERSION_FULL }}
          path: LinPlayer-AppleTV-unsigned.ipa

  publish-nightly:
    name: Publish Nightly Release (v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ubuntu-latest
    needs:
      - build-android
      - build-windows
      - build-linux
      - build-ios
      - build-macos
      - build-appletv
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Check out code (for tagging)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Ensure GitHub CLI is available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Update nightly tag
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f nightly "$GITHUB_SHA"
          git push -f origin refs/tags/nightly

      - name: Create or update nightly release
        shell: bash
        run: |
          set -euo pipefail
          NOTES="$(cat <<EOF
          Nightly build

          - Version: ${VERSION_FULL}
          - Commit: ${GITHUB_SHA}
          - Date (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          EOF
          )"

          if gh release view nightly >/dev/null 2>&1; then
            gh release edit nightly --title "Nightly (${VERSION_FULL})" --notes "$NOTES"
          else
            gh release create nightly --title "Nightly (${VERSION_FULL})" --notes "$NOTES" --prerelease
          fi

      - name: Upload release assets (overwrite)
        shell: bash
        run: |
          set -euo pipefail

          gh release upload nightly "dist/LinPlayer-Android-arm64-v8a.apk" --clobber
          gh release upload nightly "dist/LinPlayer-Android-TV.apk" --clobber
          gh release upload nightly "dist/LinPlayer-Android.apk" --clobber
          gh release upload nightly "dist/LinPlayer-Windows-Setup-x64.exe" --clobber
          gh release upload nightly "dist/LinPlayer-Linux-x86_64.tar.gz" --clobber
          gh release upload nightly "dist/LinPlayer-iOS-unsigned.ipa" --clobber
          gh release upload nightly "dist/LinPlayer-macOS-arm64.dmg" --clobber
          gh release upload nightly "dist/LinPlayer-macOS-x86_64.dmg" --clobber

          # Apple TV (tvOS) is optional/experimental.
          if [[ -f "dist/LinPlayer-AppleTV-unsigned.ipa" ]]; then
            gh release upload nightly "dist/LinPlayer-AppleTV-unsigned.ipa" --clobber
          fi

      - name: Remove stale/duplicate nightly assets
        shell: bash
        run: |
          set -euo pipefail

          # Keep only the latest asset for each expected filename, and remove any older/stale
          # LinPlayer-* assets that may have been left behind by previous workflow versions.
          expected_assets=(
            "LinPlayer-Android-arm64-v8a.apk"
            "LinPlayer-Android-TV.apk"
            "LinPlayer-Android.apk"
            "LinPlayer-Windows-Setup-x64.exe"
            "LinPlayer-Linux-x86_64.tar.gz"
            "LinPlayer-iOS-unsigned.ipa"
            "LinPlayer-macOS-arm64.dmg"
            "LinPlayer-macOS-x86_64.dmg"
          )
          if [[ -f "dist/LinPlayer-AppleTV-unsigned.ipa" ]]; then
            expected_assets+=("LinPlayer-AppleTV-unsigned.ipa")
          fi

          declare -A expected=()
          for name in "${expected_assets[@]}"; do
            expected["$name"]=1
          done

          # Fetch current nightly release assets (id, name, created_at).
          mapfile -t assets < <(
            gh api "repos/${GITHUB_REPOSITORY}/releases/tags/nightly" \
              --jq '.assets[] | "\(.id)\t\(.name)\t\(.created_at)"'
          )

          if [[ ${#assets[@]} -eq 0 ]]; then
            echo "No nightly assets found; nothing to clean."
            exit 0
          fi

          # Determine which asset id to keep for each expected name (newest created_at).
          declare -A keep_id=()
          declare -A keep_ts=()
          for line in "${assets[@]}"; do
            id="${line%%$'\t'*}"
            rest="${line#*$'\t'}"
            name="${rest%%$'\t'*}"
            ts="${rest#*$'\t'}"

            if [[ -z "${expected[$name]+x}" ]]; then
              continue
            fi

            if [[ -z "${keep_ts[$name]+x}" || "$ts" > "${keep_ts[$name]}" ]]; then
              keep_ts["$name"]="$ts"
              keep_id["$name"]="$id"
            fi
          done

          # Delete any stale LinPlayer-* assets not in expected list.
          for line in "${assets[@]}"; do
            id="${line%%$'\t'*}"
            rest="${line#*$'\t'}"
            name="${rest%%$'\t'*}"

            if [[ "$name" != LinPlayer-* ]]; then
              continue
            fi
            if [[ -n "${expected[$name]+x}" ]]; then
              continue
            fi

            echo "Deleting stale asset: $name ($id)"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/assets/$id"
          done

          # Delete duplicates for expected assets, keeping only the newest one per name.
          for line in "${assets[@]}"; do
            id="${line%%$'\t'*}"
            rest="${line#*$'\t'}"
            name="${rest%%$'\t'*}"

            if [[ -z "${expected[$name]+x}" ]]; then
              continue
            fi
            if [[ "${keep_id[$name]}" == "$id" ]]; then
              continue
            fi

            echo "Deleting duplicate asset: $name ($id)"
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/releases/assets/$id"
          done
