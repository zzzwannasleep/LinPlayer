# GitHub Actions workflow for building the Flutter application for Android and Windows.

name: Build Flutter App

# Controls when the action will run.
# This workflow is manual (use Actions tab -> Run workflow).
on:
  workflow_dispatch:
    inputs:
      build_name:
        description: Version name (e.g. 1.2.3)
        required: true
      build_number:
        description: Build number (integer, used as Android versionCode)
        required: true

jobs:
  # Job for building the Android APK
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    env:
      PUB_CACHE: /home/runner/.pub-cache
    steps:
      # 1. Check out the repository code
      - name: Check out code
        uses: actions/checkout@v4

      # 2. Set up JDK (Java Development Kit) for Android build
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Set up Flutter SDK
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use stable channel

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      # 3.5 Cache pub dependencies
      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # 4. Get Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get

      # 4.5. Static analysis
      - name: Flutter analyze
        run: flutter analyze

      # 4.6. Run tests
      - name: Flutter tests
        run: flutter test

      # 5. Build the APK in release mode
      - name: Build APK
        run: flutter build apk --release --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER"

      # 6. Upload the generated APK file as a build artifact
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Android-APK
          path: build/app/outputs/flutter-apk/app-release.apk

  # Job for building the Windows application
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    env:
      PUB_CACHE: C:\Users\runneradmin\AppData\Local\Pub\Cache
    steps:
      # 1. Check out the repository code
      - name: Check out code
        uses: actions/checkout@v4

      # 2. Set up Flutter SDK
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use stable channel

      # 2.5 Cache pub dependencies
      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # 3. Get Flutter dependencies
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Compute build version
        shell: pwsh
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: .github/scripts/compute_version.ps1

      # 4. Enable windows-desktop support in Flutter
      - name: Enable Windows desktop support
        run: flutter config --enable-windows-desktop

      # 4.5. Ensure Windows platform files are present (handles missing windows/flutter)
      - name: Regenerate Windows platform scaffolding if needed
        shell: pwsh
        run: |
          if (-not (Test-Path "windows/flutter")) {
            flutter create --platforms=windows .
          } else {
            Write-Host "windows/flutter exists; skip flutter create."
          }

      # 5. Build the Windows executable in release mode
      - name: Build Windows executable
        shell: pwsh
        run: flutter build windows --release --build-name $env:BUILD_NAME --build-number $env:BUILD_NUMBER

      # 5.5. Bundle MSVC runtime DLLs into the release folder (avoid missing VC runtime on target PCs)
      - name: Copy MSVC runtime DLLs
        shell: pwsh
        run: |
          $release64 = "build/windows/x64/runner/Release"
          $releaseLegacy = "build/windows/runner/Release"
          if (Test-Path $release64) {
            $release = $release64
          } elseif (Test-Path $releaseLegacy) {
            $release = $releaseLegacy
          } else {
            Write-Error "Release folder not found after build."
            exit 1
          }
          $roots = @(
            "C:\Program Files\Microsoft Visual Studio\2022",
            "C:\Program Files (x86)\Microsoft Visual Studio\2022"
          )
          $crtDir = $null
          foreach ($root in $roots) {
            foreach ($edition in @("Enterprise","Professional","Community","BuildTools")) {
              $search = Join-Path $root "$edition\VC\Redist\MSVC"
              if (-not (Test-Path $search)) { continue }
              $found = Get-ChildItem -Directory -Recurse -Filter "Microsoft.VC143.CRT" $search | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              if (-not $found) {
                $found = Get-ChildItem -Directory -Recurse -Filter "Microsoft.VC142.CRT" $search | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              }
              if ($found) { $crtDir = $found.FullName; break }
            }
            if ($crtDir) { break }
          }
          if (-not $crtDir) { Write-Error "MSVC CRT path not found."; exit 1 }
          Copy-Item -Path (Join-Path $crtDir "*") -Destination $release -Recurse -Force

      # 6. Build a Windows installer (setup.exe) using Inno Setup.
      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y

      - name: Build Windows installer
        shell: pwsh
        run: |
          $release64 = "build/windows/x64/runner/Release"
          $releaseLegacy = "build/windows/runner/Release"
          if (Test-Path $release64) {
            $release = $release64
          } elseif (Test-Path $releaseLegacy) {
            $release = $releaseLegacy
          } else {
            throw "Release folder not found after build."
          }

          if ([string]::IsNullOrWhiteSpace($env:APP_VERSION) -or [string]::IsNullOrWhiteSpace($env:APP_VERSION_FULL)) {
            throw "Missing APP_VERSION/APP_VERSION_FULL env vars. Did 'Compute build version' run?"
          }

          $env:SOURCE_DIR = (Resolve-Path $release).Path
          $env:OUTPUT_DIR = (Resolve-Path ".").Path
          $env:APP_ARCH = "x64"
          # APP_VERSION / APP_VERSION_FULL already set by compute_version.ps1

          $iscc = Join-Path ${env:ProgramFiles(x86)} "Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) { $iscc = Join-Path $env:ProgramFiles "Inno Setup 6\\ISCC.exe" }
          if (-not (Test-Path $iscc)) {
            $cmd = Get-Command ISCC.exe -ErrorAction SilentlyContinue
            if ($cmd) { $iscc = $cmd.Source }
          }
          if (-not (Test-Path $iscc)) { throw "ISCC.exe not found." }

          & $iscc ".github/installer/windows/linplayer.iss"

      # 7. Upload the generated installer as a build artifact
      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Windows-Setup
          path: LinPlayer-Setup-x64.exe
