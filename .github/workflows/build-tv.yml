# Build Android TV APKs only (split-per-abi) for quick testing.

name: Build Android TV APK
run-name: TV (${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})

on:
  workflow_dispatch:
    inputs:
      build_name:
        description: Version name (e.g. 1.2.3)
        required: true
      build_number:
        description: Build number (integer)
        required: true
      allow_debug_signing:
        description: Allow Android debug signing in CI (NOT OTA-safe). Only use if ANDROID_KEYSTORE_* secrets are not configured yet.
        type: boolean
        required: false
        default: false

jobs:
  build-android-tv:
    name: Build Android TV APKs (v${{ github.event.inputs.build_name }}+${{ github.event.inputs.build_number }})
    runs-on: ubuntu-latest
    env:
      PUB_CACHE: /home/runner/.pub-cache
      LINPLAYER_ALLOW_CI_DEBUG_SIGNING: ${{ github.event.inputs.allow_debug_signing }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Compute build version
        shell: bash
        env:
          BUILD_NAME_INPUT: ${{ github.event.inputs.build_name }}
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.build_number }}
        run: bash .github/scripts/compute_version.sh

      - name: Cache Flutter pub packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Generate launcher icons
        run: dart run flutter_launcher_icons

      - name: Flutter analyze
        run: flutter analyze

      - name: Flutter tests
        run: flutter test

      - name: Configure Android release signing (OTA-safe)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -n "${ANDROID_KEYSTORE_BASE64:-}" ]]; then
            python3 .github/scripts/decode_android_keystore.py android/release.keystore

            printf "storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=../release.keystore\n" \
              "$ANDROID_KEYSTORE_PASSWORD" \
              "$ANDROID_KEY_PASSWORD" \
              "$ANDROID_KEY_ALIAS" \
              > android/key.properties

            bash .github/scripts/verify_android_signing.sh \
              android/release.keystore \
              "$ANDROID_KEYSTORE_PASSWORD" \
              "$ANDROID_KEY_PASSWORD" \
              "$ANDROID_KEY_ALIAS"
          else
            if [[ "${LINPLAYER_ALLOW_CI_DEBUG_SIGNING:-}" =~ ^(1|true|yes)$ ]]; then
              echo "No ANDROID_KEYSTORE_BASE64 secret set; proceeding with debug signing (NOT OTA-safe)."
            else
              echo "No ANDROID_KEYSTORE_BASE64 secret set; refusing to build release APKs in CI." >&2
              echo "OTA upgrades require a stable signing key. Configure ANDROID_KEYSTORE_* secrets/env vars," >&2
              echo "or re-run this workflow with allow_debug_signing=true to force debug signing (not OTA-safe)." >&2
              exit 1
            fi
          fi

      - name: Build TV APKs (split-per-abi)
        shell: bash
        run: |
          set -euo pipefail
          OUT_DIR="build/ci-android-tv-apks"
          rm -rf "$OUT_DIR"
          mkdir -p "$OUT_DIR"

          flutter build apk --release --split-per-abi --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER"
          cp -v build/app/outputs/flutter-apk/app-arm64-v8a-release.apk "$OUT_DIR/LinPlayer-Android-TV-arm64-v8a.apk"
          cp -v build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk "$OUT_DIR/LinPlayer-Android-TV-armeabi-v7a.apk"

          echo "--- Staged TV APKs ---"
          ls -la "$OUT_DIR"

      - name: Upload TV APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: LinPlayer-Android-TV-APKs-${{ env.VERSION_FULL }}
          path: build/ci-android-tv-apks/*.apk

